(function(){let e=this,t=e.unitl.random,a=this.Module;this.speed=1e3/60,this.action=this.action||{},Object.assign(this.action,{"menu-show":e=>{e.classList.toggle("active"),this.runaction("menu-hide")},"menu-close":()=>this.$(".g-btn-menu").classList.remove("active"),"menu-hide":()=>{["g-file-ui"].forEach((t=>{let a=e.$("."+t);a&&(a.hidden=!0)})),e.$(".g-btn-hide").hidden=!0},"menu-reload":()=>{e.runaction("game-cores-run")},"game-welcome-elm":t=>{if(t=t||e.$(".g-game-welcome-result")){let a=e.$ce("div");return t.appendChild(a),a}},"game-welcome-additem":t=>{let a=e.$(".g-game-welcome-result");if(!a)return;let i=this.runaction("game-welcome-elm",[a]);if(!t&&0!=t)return i.innerHTML=a.getAttribute("data-nulltext");i.innerHTML=e.runaction("span_button_string",[t,{"data-downtext":{class:"g-btn",name:t,type:"down"},"data-loadtext":{class:"g-btn g-right g-blue",name:t,type:"file"}},a])},"game-welcome-WriteFile":async(t,i)=>{let n=a.RoomsInfo[t];i&&(i.removeAttribute("data-name"),(i=i.parentNode).innerHTML="");let r=await e.getContent("data-rooms",t);if(!1===n.unFile)a.FileDB.MKFILE(n.file[0],r),this.runaction("game-welcome-additem",[n.file[0]]);else{let t=r&&await e.unFile(r,(e=>{i&&(i.innerHTML=e)}));t instanceof Uint8Array?(a.FileDB.MKFILE(n.file[0],t),this.runaction("game-welcome-additem",[n.file[0]])):t?(Object.entries(t).forEach((e=>{a.FileDB.MKFILE(e[0],e[1]),this.runaction("game-welcome-additem",[e[0]]),t[e[0]]=null})),t=null):this.runaction("game-welcome-additem",[null])}i&&i.remove(),r=null},"game-welcome-ReadRooms":async()=>{this.$(".g-btn-add").hidden=!1,this.$(".g-game-ui").hidden=!1,this.$(".g-main .g-start-ui").remove(),a.RoomsInfo=await e.getAllData("data-info");let t=e.$(".g-game-welcome-result");t&&Object.entries(a.RoomsInfo).forEach((i=>{let n=!1,r=e.runaction("span_button_string",[i[0],{"data-loaddata":{class:"g-btn g-right",name:i[0],type:"info"}},t]);if(r+="<ul>",i[1].file.forEach((e=>{r+="<li>"+e+"</li>",!n&&a.system_ext&&a.system_ext.includes(e.split(".").pop())&&(n=!0)})),r+="</ul>",!n){i[0].split("-")[0].split("|").forEach((e=>{n||(n=a.system_name&&a.system_name.includes(e)||!1)}))}if(n){let e=this.runaction("game-welcome-elm",[t]);e&&(e.innerHTML=r)}}))},"game-content-add":()=>{a.system_name&&this.runaction("upload",[async(t,i,n)=>{let r=i.split(".").pop().split("?")[0],s=t.size>e.maxsize,l=new Uint8Array(await t.arrayBuffer());n&&!s||(r=e.unitl.checkBuffer(l),"unkonw"!==r&&(i=i.split(".").slice(0,-1).join(".")+"."+r,n=e.unitl.gettype(r),t=new File([t],i,{type:n})));let o=a.system_name.join("|")+"-"+i;s&&(l=new Uint8Array(await t.arrayBuffer()));let d=["zip","rar","7z"].includes(r),c=[];if(a.system_zip&&"zip"==r&&(d=!1),d){let t=this.runaction("game-welcome-elm"),n=await e.unFile(l,(e=>{t&&(t.innerHTML=i+" -- "+e)}));t&&t.remove(),Object.entries(n).forEach((e=>{c.push(e[0].split("/").pop()),a.FileDB.MKFILE(e[0],e[1]),this.runaction("game-welcome-additem",[e[0]]),n[e[0]]=null})),n=null}else c.push(i),a.FileDB.MKFILE(i,l),this.runaction("game-welcome-additem",[i]);let u={contents:s?l:t,filesize:t.size,timestamp:e.DATE,type:s?"Uint8Array":"File",version:e.version,unpack:d,system:a.system_name};await e.setItem("data-rooms",o,u),delete u.contents,u.file=c,await e.setItem("data-info",o,u),u=null,l=null,t=null}])},"game-content-bios":async i=>{let n=a.system_bios;n&&(i.removeAttribute("data-click"),e.FectchItem({url:n+(n.includes("?")?"#":"?")+t,unpack:!0,store:"data-libjs",key:"bios-"+n.split("/").pop(),process:e=>{i.innerHTML=e},success:e=>{if(!e)return i.innerHTML=i.getAttribute("data-error");Object.entries(e).forEach((e=>{a.FileDB.MKFILE("/system/"+e[0],e[1])})),i.innerHTML=i.getAttribute("data-sussces")}}))},"game-content-write":(t,i)=>{let n=i.target,r=n.getAttribute("data-name");if(r){let t=n.getAttribute("data-type");t&&("file"==t?e.runaction("game-cores-run",[r]):"down"==t?e.unitl.download(r.split("/").pop(),a.FS.readFile(r)):"info"==t&&this.runaction("game-welcome-WriteFile",[r,n]))}},"game-FS-ui-file":async(i,n)=>{if(a.system_noui)return;i=i||a.FS;let r=a.system_uiname||"glui",s=a.system_uipath||"/home/web_user/retroarch/bundle/";i.analyzePath(s+"assets/"+r).exists||Object.entries(await this.FectchItem({url:this.JSpath+"frontend/"+r+"-bundle.png?"+t,unpack:!0,store:"data-libjs",key:"retroarch-ui-"+r,version:e.version,process:e=>{n&&(n.innerHTML=e)}})).forEach((e=>{a.FileDB.MKFILE(s+e[0],e[1])}))},"game-FS-mkdir-base":e=>{["/userdata/saves","/userdata/states","/userdata/screenshots","/userdata/cheats","/userdata/rooms","/userdata/rooms/downloads","/userdata/config","/userdata/config/remaps","/userdata/thumbnails","/system"].forEach((t=>{e.analyzePath(t).exists||e.createPath("/",t,!0,!0)}))},"game-FS-mount-db":async t=>{e.runaction("game-FS-mount-path",["/userdata"]),e.runaction("game-FS-mount-path",["/home/web_user/retroarch/userdata"]),await a.FileDB.mountReady()},"game-FS-mount-path":e=>{let t=a.FS;t.analyzePath(e).exists||t.createPath("/",e,!0,!0),t.mount(a.FileDB,{},e)},"game-FS-config-cfg":async(i,n,r,s)=>{if(!a.system_cfg&&s&&(a.system_cfg=n),!i.analyzePath(n).exists){let i="",l=n.split("/").pop();if(s){let a=await e.FectchItem({url:this.JSpath+"config/"+l+".js?"+t})||"";a&&(i=(new TextDecoder).decode(a))}r instanceof Uint8Array&&(r=(new TextDecoder).decode(r)),r?i+="\n"+r:"retroarch.cfg"!=l||r||(i+=e.runaction("game-FS-config-path")),a.FileDB.MKFILE(n,i)}},"game-FS-config-path":()=>'\nmenu_mouse_enable = "true"\nmenu_pointer_enable = "true"\nsavefile_directory = "userdata/saves"\nsavestate_directory = "userdata/states"\nscreenshot_directory = "userdata/screenshots"\nsystem_directory = "system/"\nrgui_browser_directory = "userdata/rooms"\ncore_assets_directory = "userdata/rooms/downloads"\ncheat_database_path = "userdata/cheats"\nrgui_config_directory = "userdata/config"\ninput_remapping_directory = "userdata/config/remaps"\nthumbnails_directory = "userdata/thumbnails"',"game-cores-run":t=>{let i;i=a.set_argument?a.set_argument(t):["--verbose",t||"--menu"],i&&(e.$(".g-game-welcome")&&e.$(".g-game-welcome").remove(),this.$(".g-btn-forward").hidden=!1,e.isMobile&&(e.$(".g-game-ctrl").hidden=!1),a.wasmBinary||(a.wasmBinary=null,delete a.wasmBinary),a.memFile&&(Object.entries(a.memFile).forEach((t=>{e.unitl.removeURL(t[1]),a.memFile[t[0]]=null,delete a.memFile[t[0]]})),a.memFile=null,delete a.memFile),a.jsFile&&(Object.entries(a.jsFile).forEach((e=>{a.jsFile[e[0]]=null,delete a.jsFile[e[0]]})),a.jsFile=null,delete a.jsFile),a.callMain(i),this.on(document,"contextmenu",(e=>a.stopEvent(e))),e.runaction("game-cores-bindkey"),e.runaction("game-touch-key"))},"game-cores-forward":e=>{a.KeyCode_click("toggle_fast_forward")},"game-cores-sys":t=>{if(!e.$(".g-btn-hide").hidden)return this.runaction("menu-hide");a.KeyCode_click("menu_toggle")},"game-cores-base":async(t,a)=>{try{await e.runaction("game-FS-mount-db",[t]),e.runaction("game-FS-mkdir-base",[t]),await e.runaction("game-FS-config-cfg",[t,"/home/web_user/retroarch/userdata/retroarch.cfg","",!0]),await e.runaction("game-FS-ui-file",[t,a])}catch(e){}},"game-cores-bindkey":()=>{if(a.system_cfg&&a.FS.analyzePath(a.system_cfg).exists){let e=a.FS.readFile(a.system_cfg);e&&(new TextDecoder).decode(e).split("\n").forEach((e=>{let t=e.split("="),i=t[0].trim(),n=t[1]&&t[1].replace(/(\s*"|\s*')/g,"").trim();void 0!==a.keyCode_map[i]&&(a.keyCode_map[i]=n)}))}},"game-cores-install":async(i,n)=>{let r=n.target;if(!r||!r.getAttribute("data-sys"))return;let s=r.getAttribute("data-sys");r.removeAttribute("data-sys"),e.Module.canvas=e.$("#canvas");let l=s.replace(/\-/g,"_"),o=r.getAttribute("data-mode")||"",d=e.JSpath+"cores/"+(o?o+"/":"")+l+".png?"+t;a.system_key=s,a.system_keytext=l,a.system_keyend=o,a.system_fullkey=l+(o?"_"+o:"");let c=await e.FectchItem({url:d,unpack:!0,store:"data-libjs",key:"cores-"+a.system_fullkey,version:e.version,process:e=>{r.innerHTML=e}});a.jsFile={},Object.entries(c).forEach((t=>{/\.wasm/.test(t[0])?a.wasmBinary=t[1]:/\.mem/.test(t[0])?a.memFile[t[0].split("/").pop()]=e.unitl.URL(t[1],"application/octet-stream"):/\.js/.test(t[0])&&(a.jsFile[t[0]]=(new TextDecoder).decode(t[1])),delete c[t[0]]})),c=null,a.onRuntimeInitialized=async()=>{a.myRuntimeInitialized?await a.myRuntimeInitialized(a.FS,r):await e.runaction("game-cores-base",[a.FS,r]),await e.runaction("game-welcome-ReadRooms")};let u=a.jsFile["main.js"]?a.jsFile["main.js"]:e.JSpath+"action/"+(o?o+"/":"")+l+".js?"+t,m=a.jsFile[l+"_libretro.js"]||a.jsFile["retroarch.js"];if(m){"snes9x"==l&&"BinBashBanana"==o&&(m=(new TextDecoder).decode(await await this.FectchItem({url:e.JSpath+l+"_libretro.js?"+t}))),await e.addJS(u);let i=a.js_replace(m);a.myReplace&&(i=a.myReplace(i)),await e.addJS(i),a.RetroarchJS&&a.RetroarchJS()}},"game-touch-key":()=>{let t=e=>{if(e instanceof Element){let t=e.getAttribute("data-key");if(t&&e.classList.contains("vk"))return t}return""};if(e.isMobile){let i=[];this.$$("*[data-key]").forEach((n=>{["touchstart","touchmove","touchend","touchcancel"].forEach((r=>{e.on(n,r,(e=>{let n=[];"touchstart"==e.type?n=i.concat(t(e.target)):e.touches&&e.touches.length&&(n=Array.from(e.touches).map((e=>t(document.elementFromPoint(e.pageX,e.pageY))))),n.length>0&&(n=n.join(",").split(",")),n.join()!=i&&(a.KeyUp(i),a.KeyDown(n),i=n)}),{passive:!1})}))}))}else this.$$("*[data-key]").forEach((i=>{["mousedown"].forEach((n=>e.on(i,n,(e=>{let i=t(e.target);i&&a.KeyDown(i.split(","))})))),["mouseup","mouseout"].forEach((n=>e.on(i,n,(e=>{let i=t(e.target);i&&a.KeyUp(i.split(","))}))))}))},"file-menu-init":()=>{let t=e.$(".g-file-manager");e.$$(".g-file-header").forEach((a=>{let i={},n=a.getAttribute("data-db");i[a.innerHTML]={class:"g-btn g-blue2",click:"file-toggle-result",db:n},a.innerHTML=e.runaction("span_button_string",["",Object.assign(i,{"data-cleartext":{class:"g-btn g-red",click:"file-data-clear",db:n},"data-readtext":{class:"g-btn g-right",click:"file-data-read",path:a.getAttribute("data-path")||"",db:n}}),t]),["tips","result"].forEach((t=>{let i=e.$ce("tips"==t?"div":"ul");i.classList.add("g-"+t),i.setAttribute("data-click","file-"+t+"-action"),i.setAttribute("data-db",n),i.hidden=!0,a.parentNode.appendChild(i)}))}));let a=e.$(".g-file-editor-content"),i=e.$(".g-file-editor-path");["keydown","keyup"].forEach((t=>[a,i].forEach((a=>e.on(a,t,(e=>(e.stopPropagation(),!0)),!0)))))},"file-toggle-result":e=>{let t=e.getAttribute("data-db"),a=this.$(".g-result[data-db="+t+"]");a&&(a.hidden=!a.hidden)},"file-data-read":async t=>{let i=t.getAttribute("data-db"),n=e.$(".g-file-manager"),r=e.$(".g-result[data-db="+i+"]"),s="";if(r){if(r.hidden=!1,"data-info"==i){let t="data-rooms";Object.entries(await e.getAllData(i)).forEach((r=>{let l=r[0];s+="<li>";let o={"data-deltext":{class:"g-btn g-red",name:l,type:"del",db:i},"data-writetext":{class:"g-btn g-right g-blue2",name:l,type:"write",db:t},"data-downtext":{class:"g-btn g-right g-blue",name:l,type:"down",db:t}};delete o[a.onRunning?"data-downtext":"data-writetext"],s+=e.runaction("span_button_string",[l,o,n]),r[1].file&&(s+="<ul>",r[1].file.forEach((e=>{s+="<li>"+e+"</li>"})),s+="</ul>"),s+="</li>"}))}else{let r=!["userdata","retroarch"].includes(i),l=t.getAttribute("data-path");if(a.FileDB&&l)return e.runaction("file-data-fs",[l,i,l]);if(l){let e=this.$(".g-tips[data-db="+i+"]");e.hidden=!1,e.innerHTML=l}Array.from(await e.getAllKeys(i)||[]).forEach((t=>{if(!r&&!t.split(".")[1])return;let a=t;l&&(a=a.replace(l,"")),s+="<li>";let o={"data-deltext":{class:"g-btn g-red",name:t,type:"del",db:i},"data-edittext":{class:"g-btn g-blue",name:t,type:"edit",db:i},"data-downtext":{class:"g-btn g-right g-blue",name:t,type:"down",db:i}};r?(delete o["data-edittext"],delete o["data-downtext"]):["cfg","opt","cht"].includes(a.split(".").pop())||delete o["data-edittext"],s+=e.runaction("span_button_string",[a,o,n]),s+="</li>"}))}s||(s=n.getAttribute("data-nulltext")),r.innerHTML=s}},"file-data-fs":(t,i)=>{let n="",r=e.$(".g-file-manager");a.FS.readdir(t).forEach((a=>{if("."==a)return;let s=t;if(".."!=a)s+="/"+a;else{if("/"==t)return;s=t.split("/").slice(0,-1).join("/")||"/",a=r.getAttribute("data-updirtext")}n+="<li>";let l={};l[a]={class:"g-btn g-blue",type:"readpath",name:s,db:i};let o=a.split(".")[1];o&&(delete l[a].type,["cfg","opt","cht"].includes(o)&&(l["data-edittext"]={class:"g-btn g-blue2",name:s,type:"edit",db:i}),l["data-downtext"]={class:"g-btn g-right g-blue",type:"fsdown",db:i,name:s}),n+=e.runaction("span_button_string",["",l,r]),n+="</li>"})),e.$(".g-result[data-db="+i+"]").innerHTML=n},"file-result-action":async(t,i)=>{let n=i.target,r=n.getAttribute("data-type"),s=n.getAttribute("data-db"),l=n.getAttribute("data-name");s&&("down"==r?e.unitl.download(l.split("/").pop(),await e.getContent("data-info"==s?"data-rooms":s,l)):"del"==r?(await e.removeItem(s,l),"data-info"==s&&await e.removeItem("data-rooms",l),n.parentNode.remove()):"write"==r?this.runaction("game-welcome-WriteFile",[l,n]):"edit"==r?e.runaction("file-data-edit",[t,l,s]):"readpath"==r?e.runaction("file-data-fs",[l,s,n.getAttribute("data-base")]):"fsdown"==r&&e.unitl.download(l.split("/").pop(),a.FS.readFile(l))),i.preventDefault()},"file-data-clear":async t=>{let a=t.getAttribute("data-db");await e.clearDB(a),"data-rooms"==a&&await e.clearDB("data-info")},"file-data-edit":async(t,i,n)=>{if(!i)return;if(!n)return;let r=e.$(".g-file-editor");if(!r)return;r.hidden=!1;let s,l=e.$(".g-file-editor-content"),o=e.$(".g-file-editor-path");e.$(".g-file-editor-name").innerHTML=i,o.value=i,o.setAttribute("data-db",n),l.disabled=!0,s=a.FS&&!/^data\-/.test(n)?a.FS.analyzePath(i)&&a.FS.readFile(i)||"":await e.getContent(n,i)||"",s&&s.length&&(l.value=(new TextDecoder).decode(s),l.disabled=!1)},"file-data-submit":async()=>{let t=e.$(".g-file-editor");if(!t)return;t.hidden=!1,e.$(".g-file-editor").hidden=!0;let i=e.$(".g-file-editor-path"),n=i.value,r=i.getAttribute("data-db"),s=e.$(".g-file-editor-content");if(n&&r)if(a.FS&&!/^data\-/.test(r))s.disabled?a.FS.rename(e.$(".g-file-editor-name").textContent,n):s.value&&a.FileDB.MKFILE(n,(new TextEncoder).encode(s.value),!0);else{let t=await e.getItem(r,n);t&&(s.disabled?e.setItem(r,n,t):s.value&&(t.contents=(new TextEncoder).encode(s.value),e.setItem(r,n,t)))}},"file-editor-hide":e=>{e.parentNode.parentNode.hidden=!0},upload:t=>{let a=e.$ce("input");a.type="file",a.onchange=e=>{let i=e.target.files;i&&i.length>0&&Object.entries(i).forEach((e=>{return t(e[1],e[1].name,e[1].type);e[1].arrayBuffer().then((a=>{t(new Uint8Array(a),e[1].name,e[1].type)}))})),a.remove()},a.click()},"setting-callback":(t,a)=>{let i=a.target;if(i instanceof Element){let t=i.getAttribute("data-setting");t&&e.runaction("setting-"+t,[i,a])}},"setting-showfile":t=>{this.$(".g-file-ui").hidden=!1,this.$(".g-btn-hide").hidden=!1,e.runaction("menu-close")},"setting-reload":()=>{location.reload()},"setting-quality":t=>{let i=t.getAttribute("data-p");i&&(i=parseInt(i),a.canvasQuality=i>0?i:720,a.resizeCanvasSize(),e.runaction("menu-close"))},"setting-record-action":()=>{let e=this.runaction("setting-record-create");e&&("recording"==e.state?e.stop():e.start()),this.runaction("menu-close")},"setting-record-create":()=>{if(!this.Module.onRunning||!this.Module.canvas)return;if(this.Module.Record)return this.Module.Record;let t,a=this.Module.canvas.captureStream(30);return a&&["video/mp4","video/webm"].forEach((e=>{!t&&MediaRecorder.isTypeSupported(e)&&(t=new MediaRecorder(a,{mimeType:e}))})),t?(t.Blobs=[],t.ondataavailable=e=>{t.Blobs.push(e.data)},e.on(t,"stop",(e=>{if(t.Blobs.length>0){let e=t.mimeType.split(";")[0].replace(/\s/g,"");this.unitl.download("录像recorder."+e.split("/")[1],new Blob(t.Blobs,{type:e}),e),t.Blobs=[]}})),this.Module.Record=t,t):void 0},span_button_string:(e,t,a)=>{let i="";return e&&(i+="<span>"+e+"</span>"),t&&Object.entries(t).forEach((e=>{let t=e[0];/^data-/.test(t)&&(t=a.getAttribute(t)),e[1]?(i+="<span",Object.entries(e[1]).forEach((e=>{"class"==e[0]?i+=' class="'+e[1]+'"':i+=" data-"+e[0]+'="'+e[1]+'"'})),i+=">"+t+"</span>"):i+="<span>"+t+"</span>"})),i}}),this.docload((async()=>{e.runaction("file-menu-init"),this.$$("*[data-click]").forEach((t=>this.on(t,"pointerup",(function(t){let a=this.getAttribute("data-click");a&&e.runaction(a,[this,t])})))),a.stopGesture(document),this.on(window,"resize",(()=>a.resizeCanvasSize()))}))}).call(Nenge),window.onerror=function(e,t,a,i,n){var r=i?"\ncolumn: "+i:"";throw alert("Error: "+e+"\nurl: "+t+"\nline: "+a+(r+=n?"\nerror: "+n:"")),window.onerror=console.log,e};