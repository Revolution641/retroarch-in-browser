(function(){let e=this,t=e.unitl.random,a=this.Module;this.speed=1e3/60,this.action=this.action||{};let i=t=>e.$attr.getAttr.call(e.$(t)),n=(t,a,i)=>e.$attr.setAttr.call(e.$(t),a,i);Object.assign(this.action,{"menu-show":e=>{e.classList.toggle("active"),this.runaction("menu-hide")},"menu-close":()=>this.$(".g-btn-menu").classList.remove("active"),"menu-hide":()=>{["g-file-ui"].forEach((t=>{let a=e.$("."+t);a&&(a.hidden=!0)})),e.$(".g-btn-hide").hidden=!0},"menu-reload":()=>{e.runaction("game-cores-run")},"game-welcome-elm":t=>{if(t=t||e.$(".g-game-welcome-result")){let a=e.$ce("div");return t.appendChild(a),a}},"game-welcome-additem":t=>{let a=e.$(".g-game-welcome-result");if(!a)return;let n=this.runaction("game-welcome-elm",[a]);if(!t&&0!=t)return n.innerHTML=i(a)["data-nulltext"];n.innerHTML=e.runaction("span_button_string",[t,{"data-downtext":{class:"g-btn",name:t,type:"down"},"data-loadtext":{class:"g-btn g-right g-blue",name:t,type:"file"}},a])},"game-welcome-WriteFile":async(t,i)=>{let s=a.RoomsInfo[t];i&&(n(i,"data-name"),(i=i.parentNode).innerHTML="");let r=await e.getContent("data-rooms",t);if(!1===s.unFile)a.FileDB.MKFILE(s.file[0],r),this.runaction("game-welcome-additem",[s.file[0]]);else{let t=r&&await e.unFile(r,(e=>{i&&(i.innerHTML=e)}));t instanceof Uint8Array?(a.FileDB.MKFILE(s.file[0],t),this.runaction("game-welcome-additem",[s.file[0]])):t?(Object.entries(t).forEach((e=>{a.FileDB.MKFILE(e[0],e[1]),this.runaction("game-welcome-additem",[e[0]]),t[e[0]]=null})),t=null):this.runaction("game-welcome-additem",[null])}i&&i.remove(),r=null},"game-welcome-ReadRooms":async()=>{this.$(".g-btn-add").hidden=!1,this.$(".g-game-ui").hidden=!1,this.$(".g-main .g-start-ui").remove(),a.RoomsInfo=await e.getAllData("data-info");let t=e.$(".g-game-welcome-result");t&&Object.entries(a.RoomsInfo).forEach((i=>{let n=!1,s=e.runaction("span_button_string",[i[0],{"data-loaddata":{class:"g-btn g-right",name:i[0],type:"info"}},t]);if(s+="<ul>",i[1].file.forEach((e=>{s+="<li>"+e+"</li>",!n&&a.system_ext&&a.system_ext.includes(e.split(".").pop())&&(n=!0)})),s+="</ul>",!n){i[0].split("-")[0].split("|").forEach((e=>{n||(n=a.system_name&&a.system_name.includes(e)||!1)}))}if(n){let e=this.runaction("game-welcome-elm",[t]);e&&(e.innerHTML=s)}}))},"game-content-add":()=>{a.system_name&&this.runaction("upload",[async(t,i,n)=>{let s=i.split(".").pop().split("?")[0],r=t.size>e.maxsize,l=new Uint8Array(await t.arrayBuffer());n&&!r||(s=e.unitl.checkBuffer(l),"unkonw"!==s&&(i=i.split(".").slice(0,-1).join(".")+"."+s,n=e.unitl.gettype(s),t=new File([t],i,{type:n})));let o=a.system_name.join("|")+"-"+i;r&&(l=new Uint8Array(await t.arrayBuffer()));let d=["zip","rar","7z"].includes(s),c=[];if(a.system_zip&&"zip"==s&&(d=!1),d){let t=this.runaction("game-welcome-elm"),n=await e.unFile(l,(e=>{t&&(t.innerHTML=i+" -- "+e)}));t&&t.remove(),Object.entries(n).forEach((e=>{c.push(e[0].split("/").pop()),a.FileDB.MKFILE(e[0],e[1]),this.runaction("game-welcome-additem",[e[0]]),n[e[0]]=null})),n=null}else c.push(i),a.FileDB.MKFILE(i,l),this.runaction("game-welcome-additem",[i]);let u={contents:r?l:t,filesize:t.size,timestamp:e.DATE,type:r?"Uint8Array":"File",version:e.version,unpack:d,system:a.system_name};await e.setItem("data-rooms",o,u),delete u.contents,u.file=c,await e.setItem("data-info",o,u),u=null,l=null,t=null}])},"game-content-bios":async s=>{let r=a.system_bios,l=i(s);r&&(n(s,"data-click"),e.FetchItem({url:r+(r.includes("?")?"#":"?")+t,unpack:!0,store:"data-libjs",key:"bios-"+r.split("/").pop(),process:e=>{s.innerHTML=e},success:e=>{if(!e)return s.innerHTML=l["data-error"];Object.entries(e).forEach((e=>{a.FileDB.MKFILE("/system/"+e[0],e[1])})),s.innerHTML=l["data-sussces"]}}))},"game-content-write":(t,n)=>{let s=n.target,r=i(s),l=r["data-name"];if(l){let t=r["data-type"];t&&("file"==t?e.runaction("game-cores-run",[l]):"down"==t?e.unitl.download(l.split("/").pop(),a.FS.readFile(l)):"info"==t&&this.runaction("game-welcome-WriteFile",[l,s]))}},"game-FS-ui-file":async(i,n)=>{if(a.system_noui)return;i=i||a.FS;let s=a.system_uiname||"glui",r=a.system_uipath||"/home/web_user/retroarch/bundle/";i.analyzePath(r+"assets/"+s).exists||Object.entries(await this.FetchItem({url:this.JSpath+"frontend/"+s+"-bundle.png?"+t,unpack:!0,store:"data-libjs",key:"retroarch-ui-"+s,version:e.version,process:e=>{n&&(n.innerHTML=e)}})).forEach((e=>{a.FileDB.MKFILE(r+e[0],e[1])}))},"game-FS-mkdir-base":e=>{["/userdata/saves","/userdata/states","/userdata/screenshots","/userdata/cheats","/userdata/rooms","/userdata/rooms/downloads","/userdata/config","/userdata/config/remaps","/userdata/thumbnails","/system"].forEach((t=>{e.analyzePath(t).exists||e.createPath("/",t,!0,!0)}))},"game-FS-mount-db":async t=>{e.runaction("game-FS-mount-path",["/userdata"]),e.runaction("game-FS-mount-path",["/home/web_user/retroarch/userdata"]),await a.FileDB.mountReady()},"game-FS-mount-path":e=>{let t=a.FS;t.analyzePath(e).exists||t.createPath("/",e,!0,!0),t.mount(a.FileDB,{},e)},"game-FS-config-cfg":async(i,n,s,r)=>{if(!a.system_cfg&&r&&(a.system_cfg=n),!i.analyzePath(n).exists){let i="",l=n.split("/").pop();if(r){let a=await e.FetchItem({url:this.JSpath+"config/"+l+".js?"+t})||"";a&&(i=(new TextDecoder).decode(a))}s instanceof Uint8Array&&(s=(new TextDecoder).decode(s)),s?i+="\n"+s:"retroarch.cfg"!=l||s||(i+=e.runaction("game-FS-config-path")),a.FileDB.MKFILE(n,i)}},"game-FS-config-path":()=>'\nmenu_mouse_enable = "true"\nmenu_pointer_enable = "true"\nsavefile_directory = "userdata/saves"\nsavestate_directory = "userdata/states"\nscreenshot_directory = "userdata/screenshots"\nsystem_directory = "system/"\nrgui_browser_directory = "userdata/rooms"\ncore_assets_directory = "userdata/rooms/downloads"\ncheat_database_path = "userdata/cheats"\nrgui_config_directory = "userdata/config"\ninput_remapping_directory = "userdata/config/remaps"\nthumbnails_directory = "userdata/thumbnails"',"game-cores-run":t=>{let i;i=a.set_argument?a.set_argument(t):["--verbose",t||"--menu"],i&&(e.$(".g-game-welcome")&&e.$(".g-game-welcome").remove(),this.$(".g-btn-forward").hidden=!1,e.isMobile&&(e.$(".g-game-ctrl").hidden=!1),a.wasmBinary||(a.wasmBinary=null,delete a.wasmBinary),a.memFile&&(Object.entries(a.memFile).forEach((t=>{e.unitl.removeURL(t[1]),a.memFile[t[0]]=null,delete a.memFile[t[0]]})),a.memFile=null,delete a.memFile),a.jsFile&&(Object.entries(a.jsFile).forEach((e=>{a.jsFile[e[0]]=null,delete a.jsFile[e[0]]})),a.jsFile=null,delete a.jsFile),a.callMain(i),this.on(document,"contextmenu",(e=>a.stopEvent(e))),e.runaction("game-cores-bindkey"),e.runaction("game-touch-key"))},"game-cores-forward":e=>{a.KeyCode_click("toggle_fast_forward")},"game-cores-sys":t=>{if(!e.$(".g-btn-hide").hidden)return this.runaction("menu-hide");a.KeyCode_click("menu_toggle")},"game-cores-base":async(t,a)=>{try{await e.runaction("game-FS-mount-db",[t]),e.runaction("game-FS-mkdir-base",[t]),await e.runaction("game-FS-config-cfg",[t,"/home/web_user/retroarch/userdata/retroarch.cfg","",!0]),await e.runaction("game-FS-ui-file",[t,a])}catch(e){}},"game-cores-bindkey":()=>{if(a.system_cfg&&a.FS.analyzePath(a.system_cfg).exists){let e=a.FS.readFile(a.system_cfg);e&&(new TextDecoder).decode(e).split("\n").forEach((e=>{let t=e.split("="),i=t[0].trim(),n=t[1]&&t[1].replace(/(\s*"|\s*')/g,"").trim();void 0!==a.keyCode_map[i]&&(a.keyCode_map[i]=n)}))}},"game-cores-install":async(s,r)=>{let l=r.target,o=i(l);if(!l||!o["data-sys"])return;let d=o["data-sys"];n(l,"data-sys"),e.Module.canvas=e.$("#canvas");let c=d.replace(/\-/g,"_"),u=o["data-mode"]||"",m=e.JSpath+"cores/"+(u?u+"/":"")+c+".png?"+t;a.system_key=d,a.system_keytext=c,a.system_keyend=u,a.system_fullkey=c+(u?"_"+u:"");let g=await e.FetchItem({url:m,unpack:!0,store:"data-libjs",key:"cores-"+a.system_fullkey,version:e.version,process:e=>{l.innerHTML=e}});a.jsFile={},Object.entries(g).forEach((t=>{/\.wasm/.test(t[0])?a.wasmBinary=t[1]:/\.mem/.test(t[0])?a.memFile[t[0].split("/").pop()]=e.unitl.URL(t[1],"application/octet-stream"):/\.js/.test(t[0])&&(a.jsFile[t[0]]=(new TextDecoder).decode(t[1])),delete g[t[0]]})),g=null,a.onRuntimeInitialized=async()=>{a.myRuntimeInitialized?await a.myRuntimeInitialized(a.FS,l):await e.runaction("game-cores-base",[a.FS,l]),await e.runaction("game-welcome-ReadRooms")};let h=a.jsFile["main.js"]?a.jsFile["main.js"]:e.JSpath+"action/"+(u?u+"/":"")+c+".js?"+t,f=a.jsFile[c+"_libretro.js"]||a.jsFile["retroarch.js"];if(f){"snes9x"==c&&"BinBashBanana"==u&&(f=(new TextDecoder).decode(await await this.FetchItem({url:e.JSpath+c+"_libretro.js?"+t}))),await e.addJS(h);let i=a.js_replace(f);a.myReplace&&(i=a.myReplace(i)),await e.addJS(i),a.RetroarchJS&&a.RetroarchJS()}},"game-touch-key":()=>{let t=e=>{if(e instanceof Element){let t=i(e)["data-key"];if(t&&e.classList.contains("vk"))return t}return""};if(e.isMobile){let i=[];this.$$("*[data-key]").forEach((n=>{["touchstart","touchmove","touchend","touchcancel"].forEach((s=>{e.on(n,s,(e=>{let n=[];"touchstart"==e.type?n=i.concat(t(e.target)):e.touches&&e.touches.length&&(n=Array.from(e.touches).map((e=>t(document.elementFromPoint(e.pageX,e.pageY))))),n.length>0&&(n=n.join(",").split(",")),n.join()!=i&&(a.KeyUp(i),a.KeyDown(n),i=n)}),{passive:!1})}))}))}else this.$$("*[data-key]").forEach((i=>{["mousedown"].forEach((n=>e.on(i,n,(e=>{let i=t(e.target);i&&a.KeyDown(i.split(","))})))),["mouseup","mouseout"].forEach((n=>e.on(i,n,(e=>{let i=t(e.target);i&&a.KeyUp(i.split(","))}))))}))},"file-menu-init":()=>{let t=e.$(".g-file-manager");e.$$(".g-file-header").forEach((a=>{let s={},r=i(a),l=r["data-db"];s[a.innerHTML]={class:"g-btn g-blue2",click:"file-toggle-result",db:l},a.innerHTML=e.runaction("span_button_string",["",Object.assign(s,{"data-cleartext":{class:"g-btn g-red",click:"file-data-clear",db:l},"data-readtext":{class:"g-btn g-right",click:"file-data-read",path:r["data-path"]||"",db:l}}),t]),["tips","result"].forEach((t=>{let i=e.$ce("tips"==t?"div":"ul");i.classList.add("g-"+t),n(i,"data-click","file-"+t+"-action"),n(i,"data-db",l),i.hidden=!0,a.parentNode.appendChild(i)}))}));let a=e.$(".g-file-editor-content"),s=e.$(".g-file-editor-path");["keydown","keyup"].forEach((t=>[a,s].forEach((a=>e.on(a,t,(e=>(e.stopPropagation(),!0)),!0)))))},"file-toggle-result":e=>{let t=i(e)["data-db"],a=this.$(".g-result[data-db="+t+"]");a&&(a.hidden=!a.hidden)},"file-data-read":async t=>{let n=i(t),s=n["data-db"],r=e.$(".g-file-manager"),l=e.$(".g-result[data-db="+s+"]"),o="";if(l){if(l.hidden=!1,"data-info"==s){let t="data-rooms";Object.entries(await e.getAllData(s)).forEach((i=>{let n=i[0];o+="<li>";let l={"data-deltext":{class:"g-btn g-red",name:n,type:"del",db:s},"data-writetext":{class:"g-btn g-right g-blue2",name:n,type:"write",db:t},"data-downtext":{class:"g-btn g-right g-blue",name:n,type:"down",db:t}};delete l[a.onRunning?"data-downtext":"data-writetext"],o+=e.runaction("span_button_string",[n,l,r]),i[1].file&&(o+="<ul>",i[1].file.forEach((e=>{o+="<li>"+e+"</li>"})),o+="</ul>"),o+="</li>"}))}else{let t=!["userdata","retroarch"].includes(s),i=n["data-path"];if(a.FileDB&&i)return e.runaction("file-data-fs",[i,s,i]);if(i){let e=this.$(".g-tips[data-db="+s+"]");e.hidden=!1,e.innerHTML=i}Array.from(await e.getAllKeys(s)||[]).forEach((a=>{if(!t&&!a.split(".")[1])return;let n=a;i&&(n=n.replace(i,"")),o+="<li>";let l={"data-deltext":{class:"g-btn g-red",name:a,type:"del",db:s},"data-edittext":{class:"g-btn g-blue",name:a,type:"edit",db:s},"data-downtext":{class:"g-btn g-right g-blue",name:a,type:"down",db:s}};t?(delete l["data-edittext"],delete l["data-downtext"]):["cfg","opt","cht"].includes(n.split(".").pop())||delete l["data-edittext"],o+=e.runaction("span_button_string",[n,l,r]),o+="</li>"}))}o||(o=i(r)["data-nulltext"]),l.innerHTML=o}},"file-data-fs":(t,n)=>{let s="",r=e.$(".g-file-manager");a.FS.readdir(t).forEach((a=>{if("."==a)return;let l=t;if(".."!=a)l+="/"+a;else{if("/"==t)return;l=t.split("/").slice(0,-1).join("/")||"/",a=i(r)["data-updirtext"]}s+="<li>";let o={};o[a]={class:"g-btn g-blue",type:"readpath",name:l,db:n};let d=a.split(".")[1];d&&(delete o[a].type,["cfg","opt","cht"].includes(d)&&(o["data-edittext"]={class:"g-btn g-blue2",name:l,type:"edit",db:n}),o["data-downtext"]={class:"g-btn g-right g-blue",type:"fsdown",db:n,name:l}),s+=e.runaction("span_button_string",["",o,r]),s+="</li>"})),e.$(".g-result[data-db="+n+"]").innerHTML=s},"file-result-action":async(t,n)=>{let s=n.target,r=i(s),l=r["data-type"],o=r["data-db"],d=r["data-name"];o&&("down"==l?e.unitl.download(d.split("/").pop(),await e.getContent("data-info"==o?"data-rooms":o,d)):"del"==l?(await e.removeItem(o,d),"data-info"==o&&await e.removeItem("data-rooms",d),s.parentNode.remove()):"write"==l?this.runaction("game-welcome-WriteFile",[d,s]):"edit"==l?e.runaction("file-data-edit",[t,d,o]):"readpath"==l?e.runaction("file-data-fs",[d,o]):"fsdown"==l&&e.unitl.download(d.split("/").pop(),a.FS.readFile(d))),n.preventDefault()},"file-data-clear":async t=>{let a=i(t)["data-db"];await e.clearDB(a),"data-rooms"==a&&await e.clearDB("data-info")},"file-data-edit":async(t,i,s)=>{if(!i)return;if(!s)return;let r=e.$(".g-file-editor");if(!r)return;r.hidden=!1;let l,o=e.$(".g-file-editor-content"),d=e.$(".g-file-editor-path");e.$(".g-file-editor-name").innerHTML=i,d.value=i,n(d,"data-db",s),o.disabled=!0,l=a.FS&&!/^data\-/.test(s)?a.FS.analyzePath(i)&&a.FS.readFile(i)||"":await e.getContent(s,i)||"",l&&l.length&&(o.value=(new TextDecoder).decode(l),o.disabled=!1)},"file-data-submit":async()=>{let t=e.$(".g-file-editor");if(!t)return;t.hidden=!1,e.$(".g-file-editor").hidden=!0;let n=e.$(".g-file-editor-path"),s=n.value,r=i(n)["data-db"],l=e.$(".g-file-editor-content");if(s&&r)if(a.FS&&!/^data\-/.test(r))l.disabled?a.FS.rename(e.$(".g-file-editor-name").textContent,s):l.value&&a.FileDB.MKFILE(s,(new TextEncoder).encode(l.value),!0);else{let t=await e.getItem(r,s);t&&(l.disabled?e.setItem(r,s,t):l.value&&(t.contents=(new TextEncoder).encode(l.value),e.setItem(r,s,t)))}},"file-editor-hide":e=>{e.parentNode.parentNode.hidden=!0},upload:t=>{let a=e.$ce("input");a.type="file",a.onchange=e=>{let i=e.target.files;i&&i.length>0&&Object.entries(i).forEach((e=>{return t(e[1],e[1].name,e[1].type);e[1].arrayBuffer().then((a=>{t(new Uint8Array(a),e[1].name,e[1].type)}))})),a.remove()},a.click()},"setting-callback":(t,a)=>{let n=a.target;if(n instanceof Element){let t=i(n)["data-setting"];t&&e.runaction("setting-"+t,[n,a])}},"setting-showfile":t=>{this.$(".g-file-ui").hidden=!1,this.$(".g-btn-hide").hidden=!1,e.runaction("menu-close")},"setting-reload":()=>{location.reload()},"setting-quality":t=>{let n=i(t)["data-p"];n&&(n=parseInt(n),a.canvasQuality=n>0?n:720,a.resizeCanvasSize(),e.runaction("menu-close"))},"setting-record-action":()=>{let e=this.runaction("setting-record-create");e&&("recording"==e.state?e.stop():e.start()),this.runaction("menu-close")},"setting-record-create":()=>{if(!this.Module.onRunning||!this.Module.canvas)return;if(this.Module.Record)return this.Module.Record;let t,a=this.Module.canvas.captureStream(30);return a&&["video/mp4","video/webm"].forEach((e=>{!t&&MediaRecorder.isTypeSupported(e)&&(t=new MediaRecorder(a,{mimeType:e}))})),t?(t.Blobs=[],t.ondataavailable=e=>{t.Blobs.push(e.data)},e.on(t,"stop",(e=>{if(t.Blobs.length>0){let e=t.mimeType.split(";")[0].replace(/\s/g,"");this.unitl.download("录像recorder."+e.split("/")[1],new Blob(t.Blobs,{type:e}),e),t.Blobs=[]}})),this.Module.Record=t,t):void 0},span_button_string:(e,t,a)=>{let n="",s=i(a);return e&&(n+="<span>"+e+"</span>"),t&&Object.entries(t).forEach((e=>{let t=e[0];/^data-/.test(t)&&(t=s[t]),e[1]?(n+="<span",Object.entries(e[1]).forEach((e=>{"class"==e[0]?n+=' class="'+e[1]+'"':n+=" data-"+e[0]+'="'+e[1]+'"'})),n+=">"+t+"</span>"):n+="<span>"+t+"</span>"})),n}}),this.docload((async()=>{e.runaction("file-menu-init"),this.$$("*[data-click]").forEach((t=>this.on(t,"pointerup",(function(t){let a=i(this)["data-click"];a&&e.runaction(a,[this,t])})))),a.stopGesture(document),this.on(window,"resize",(()=>a.resizeCanvasSize()))})),e.on(window,"error",(function(e){let{message:t,filename:a,lineno:i,colno:n,error:s}=e;var r=n?"\ncolumn: "+n:"";throw alert("Error: "+t+"\nurl: "+a+"\nline: "+i+(r+=s?"\nerror: "+s:"")),t}))}).call(Nenge);